<!DOCTYPE HTML>
<link rel="stylesheet" type="text/css" href="auto-number-title.css" />

<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>多机多卡 - PytorchInActions</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The note of Papers">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/pagetoc.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">pytorch的基本用法</li><li class="chapter-item expanded "><a href="../basic/create.html"><strong aria-hidden="true">1.</strong> 声明</a></li><li class="chapter-item expanded "><a href="../basic/init.html"><strong aria-hidden="true">2.</strong> 初始化</a></li><li class="chapter-item expanded "><a href="../basic/layers.html"><strong aria-hidden="true">3.</strong> 层</a></li><li class="chapter-item expanded "><a href="../basic/dataloader.html"><strong aria-hidden="true">4.</strong> 数据</a></li><li class="chapter-item expanded "><a href="../basic/pipeline.html"><strong aria-hidden="true">5.</strong> pipeline</a></li><li class="chapter-item expanded "><a href="../basic/train.html"><strong aria-hidden="true">6.</strong> 训练</a></li><li class="chapter-item expanded affix "><li class="part-title">开源代码实战</li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> 数据</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">7.1.</strong> 特征数据的加工</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../opensource/data/feature/image.html"><strong aria-hidden="true">7.1.1.</strong> 图像信息</a></li><li class="chapter-item expanded "><a href="../opensource/data/feature/image_clip_embedding.html"><strong aria-hidden="true">7.1.2.</strong> 图像信息 - Clip Embedding</a></li><li class="chapter-item expanded "><a href="../opensource/data/feature/video.html"><strong aria-hidden="true">7.1.3.</strong> 视频信息</a></li><li class="chapter-item expanded "><a href="../opensource/data/feature/text.html"><strong aria-hidden="true">7.1.4.</strong> 文本信息</a></li><li class="chapter-item expanded "><a href="../opensource/data/feature/class.html"><strong aria-hidden="true">7.1.5.</strong> 类别信息</a></li><li class="chapter-item expanded "><a href="../opensource/data/feature/2DPose.html"><strong aria-hidden="true">7.1.6.</strong> 2D Pose信息</a></li><li class="chapter-item expanded "><a href="../opensource/data/feature/drag.html"><strong aria-hidden="true">7.1.7.</strong> 拖拽交互信息</a></li></ol></li><li class="chapter-item expanded "><a href="../opensource/data/label.html"><strong aria-hidden="true">7.2.</strong> 标签数据的监督</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.3.</strong> 数据的结合</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../opensource/data/combine/feature.html"><strong aria-hidden="true">7.3.1.</strong> 不同特征的结合</a></li><li class="chapter-item expanded "><a href="../opensource/data/combine/multimodal.html"><strong aria-hidden="true">7.3.2.</strong> 不同特征的融合</a></li><li class="chapter-item expanded "><a href="../opensource/data/combine/condition.html"><strong aria-hidden="true">7.3.3.</strong> 控制信号的注入</a></li><li class="chapter-item expanded "><a href="../opensource/data/combine/dataset.html"><strong aria-hidden="true">7.3.4.</strong> 不同数据集的结合</a></li><li class="chapter-item expanded "><a href="../opensource/data/combine/target.html"><strong aria-hidden="true">7.3.5.</strong> 不同目标的结合</a></li></ol></li><li class="chapter-item expanded "><a href="../opensource/data/sync.html"><strong aria-hidden="true">7.4.</strong> 数据同步</a></li><li class="chapter-item expanded "><a href="../opensource/data/prepost.html"><strong aria-hidden="true">7.5.</strong> 预处理和后处理</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> 模型</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../opensource/model/init.html"><strong aria-hidden="true">8.1.</strong> 参数初始化</a></li><li class="chapter-item expanded "><a href="../opensource/model/temporal.html"><strong aria-hidden="true">8.2.</strong> 时序层</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> 框架</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../opensource/framework/training.html"><strong aria-hidden="true">9.1.</strong> 训练方法</a></li><li class="chapter-item expanded "><a href="../opensource/framework/long_term.html"><strong aria-hidden="true">9.2.</strong> 长序列推断策略</a></li></ol></li><li class="chapter-item expanded "><a href="../opensource/evalute.html"><strong aria-hidden="true">10.</strong> 评价指标</a></li><li class="chapter-item expanded affix "><li class="part-title">pytorch深入理解</li><li class="chapter-item expanded "><a href="../opensource/DP.html"><strong aria-hidden="true">11.</strong> 单机多卡</a></li><li class="chapter-item expanded "><a href="../opensource/DDP.html" class="active"><strong aria-hidden="true">12.</strong> 多机多卡</a></li><li class="chapter-item expanded affix "><li class="part-title">其它常用库</li><li class="chapter-item expanded "><a href="../libs/config.html"><strong aria-hidden="true">13.</strong> config</a></li><li class="chapter-item expanded "><a href="../libs/cv2.html"><strong aria-hidden="true">14.</strong> cv2</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PytorchInActions</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/CaterpillarStudyGroup/PytorchInAction" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main><div class="sidetoc"><nav class="pagetoc"></nav></div>
                        <h1 id="distributeddataparallel"><a class="header" href="#distributeddataparallel">DistributedDataParallel</a></h1>
<p>支持多机多卡，效率高，但是要折腾一下代码，DDP是一个支持多机多卡、分布式训练的深度学习工程方法。</p>
<p>在DDP模式下，会有N个进程被启动，每个进程在一张卡上加载一个模型，这些模型的参数在数值上是相同的。
在模型训练时，各个进程通过一种叫Ring-Reduce的方法与其他进程通讯，交换各自的梯度，从而获得所有进程的梯度；
各个进程用平均后的梯度更新自己的参数，因为各个进程的初始参数、更新梯度是一致的，所以更新后的参数也是完全相同的。</p>
<p>每个进程一张卡，这是DDP的最佳使用方法。
每个进程多张卡，并行模式。一个模型的不同部分分布在不同的卡上面。例如，网络的前半部分在0号卡上，后半部分在1号卡上。这种场景，一般是因为我们的模型非常大，大到一张卡都塞不下batch size = 1的一个模型。</p>
<ul>
<li>group，即进程组。默认情况下，只有一个组。这个可以先不管，一直用默认的就行。</li>
<li>world size，表示全局的并行数，如果只开了一个进程那就是1。</li>
<li>rank，当前进程的序号，用于进程间通讯。对于16的world size来说，就是0,1,2,…,15。注意：rank=0的进程就是master进程。</li>
<li>local_rank，又一个序号。这是每台机子上的进程的序号。机器一上有0,1,2,3,4,5,6,7，机器二上也有0,1,2,3,4,5,6,7。<strong>一般情况下，你需要用这个local_rank来手动设置当前模型是跑在当前机器的哪块GPU上面的。</strong></li>
</ul>
<pre><code class="language-python"># 获取world size，在不同进程里都是一样的
torch.distributed.get_world_size()
# 获取rank，每个进程都有自己的序号，各不相同
torch.distributed.get_rank()
# 获取local_rank。一般情况下，你需要用这个local_rank来手动设置当前模型是跑在当前机器的哪块GPU上面的。
torch.distributed.local_rank()
</code></pre>
<p>Demo:</p>
<pre><code class="language-python">## main.py文件
import os
import torch
import torch.nn as nn
from torch import optim
from torch.nn.parallel import DistributedDataParallel as DDP
import torch.distributed as dist
from torch.utils.data import DataLoader, data
import warnings 
warnings.filterwarnings('ignore')
local_rank = int(os.environ[&quot;LOCAL_RANK&quot;])

torch.cuda.set_device(local_rank)
dist.init_process_group(backend='nccl')
device = torch.device(&quot;cuda&quot;, local_rank)

# print(f&quot;world size: {torch.distributed.get_world_size()}&quot;)
print(f&quot;rank: {torch.distributed.get_rank()}&quot;)

class CPPDataset(data.Dataset):
    def __init__(self, seqs, labels):
        self.seqs = seqs
        self.labels = labels
    def __len__(self):
        return len(self.seqs)
    def __getitem__(self, idx):
        return self.seqs[idx], self.labels[idx]


# 构造模型
model = nn.Linear(10, 1).to(device)
model = DDP(model, device_ids=[local_rank], output_device=local_rank)

X_train = torch.Tensor(64,10).to(device)
y_train = torch.zeros(64).to(device)
train_dataset = CPPDataset(X_train, y_train)

# 新增1：使用DistributedSampler，DDP帮我们把细节都封装起来了。用，就完事儿！
#       sampler的原理，后面也会介绍。
train_sampler = torch.utils.data.distributed.DistributedSampler(train_dataset)
# 需要注意的是，这里的batch_size指的是每个进程下的batch_size。也就是说，总batch_size是这里的batch_size再乘以并行数(world_size)。
trainloader = torch.utils.data.DataLoader(train_dataset, batch_size=4, sampler=train_sampler)

loss_fn = nn.MSELoss()

for epoch in range(4):
    # 新增2：设置sampler的epoch，DistributedSampler需要这个来维持各个进程之间的相同随机数种子
    trainloader.sampler.set_epoch(epoch)
    # 后面这部分，则与原来完全一致了。
    for x, yy in trainloader:
        prediction = model(x)
        
        loss = loss_fn(prediction.squeeze(), yy)
        loss.backward()
        optimizer = optim.SGD(model.parameters(), lr=0.001)
        optimizer.step()
        
    # 保存模型参数只需要在rank=0上保存
    if dist.get_rank() == 0:
            checkpoint = {
                &quot;net&quot;: model.module.state_dict()
            }
            torch.save(checkpoint, 'model.pt'))
</code></pre>
<p>最终通过运行torchrun --nproc_per_node 4 main.py 即可实现单机多卡训练。
当你希望在一个机器上同时跑两个torchrun程序，请使用torchrun --nproc_per_node 4 -master_port=22224 main.py，master_port的数字不能与正在运行的程序一致，会产生冲突。</p>
<p>注意点：</p>
<ol>
<li>保存模型 checkpoint、记录 tensorboard、输出准确率、甚至是 tqdm 都只让主进程（rank0）执行，其他进程不执行。</li>
<li>在用 DDP 封装模型后，模型的本体（我们定义的那个类）是 model.module；所以保存模型时，最好保存 model.module.state_dict()，否则存下来的参数的 key 前面会多一个 module.，不便再次 load 模型。</li>
<li>我们经常会在训练的每个 epoch 后进行 evaluate / inference，为避免有些进程测试完之后开始了下一轮训练，但其他进程还在测试，最好在每个 epoch 开始训练前（或者每个 epoch 完成训练后）用 dist.barrier() 同步一下。对于数据的读取是采用主进程预读取并缓存，然后其它进程从缓存中读取，不同进程之间的数据同步具体通过torch.distributed.barrier()实现。</li>
<li>单卡 evaluate / inference 用的模型最好是本地模型 model.module 而非 DDP 包装的模型，否则非主进程会在第 3 条的 dist.barrier() 处卡死，推测原因是 DDP 包装的模型会在一些地方同步 bucket。</li>
<li>如果模型在forward的时候出现没有使用的output，比如(logits, _)= model(x_pad, mask)，则有可能会报错，报错内容如下。需要在封装DDP的地方增加一个参数 find_unused_parameters=True)</li>
</ol>
<h1 id="参考链接"><a class="header" href="#参考链接">参考链接</a></h1>
<p>原文链接：https://blog.csdn.net/qq_41020633/article/details/128902848</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../opensource/DP.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../libs/config.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../opensource/DP.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../libs/config.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/pagetoc.js"></script>
    </body>
</html>
